---
title: "PROBA"
author: "Gabriel Regueira Huguet"
date: "2025-03-22"
output:
  pdf_document: default
  html_document: default
---

Se ha descubierto que el dataset de cachexia ya esta en un paquete llamado specmine.dataset:
```{r}
library(specmine.datasets)
data("cachexia")
```

```{r}
class(cachexia)
```

Com podem observar, cachexia és una llista personalitzada utilitzada per el paquet specmine.datasets. Al executar View(cachecia) no surt una taula de dades convencional, sinó una vista estructurada dels components del dataset *cachexia*.

Observem en el dataset de *cachexia* que aquest té diferents elements:

- data: matriu 63 x 77 (metabolites x mostres)

- metadata: data.frame amb informació sobre cada mostra (grup) 

- description: petita descripció sobre les dades

Ara procedim a crear el *SummarizedExperiment*:

```{r}
library(SummarizedExperiment)
#Convertim cachexia$data a una matriu R per tal que SummarizedExperiment accepti el format i formi part del component assays
assay_data <- as.matrix(cachexia$data)
#Agafem cachexia$metadata i ens assegurem que els noms de les files coincideixin amb le nom de les columnes de la matriu de dades (assay):
col_metadata <- cachexia$metadata
rownames(col_metadata) <- colnames(assay_data)
#Creem l'objecte SummarizedExperiment amb la matriu de dades empaquetada en una llista (counts) i les metadades de les columnes (mostres)
se <- SummarizedExperiment(
  assays = list(counts = assay_data),
  colData = col_metadata
)
```


```{r}
se
```
```{r}
View(assay(se))
View(colData(se))
colData(se)
```
```{r}
colnames(colData(se))
```
```{r}
se
```
Una vegada creat el *SummarizedExperiment*, el guardarem en un arxiu en format .Rda com indica l'enunciat:

```{r}
save(se, file = "se_cachexia.rda")
```


**ANÀLISIS EXPLORATORI**

```{r}
load("se_cachexia.rda")
```

```{r}
apply(assay(se), 1, summary)
```
```{r}
dim(se) #Nombre de files i columnes 
```
Ena quest cas, es pot deduïr que les variables són 63 concentracions de metabòlits analitzats en la orina de 77 individus. Totes les variables, doncs, són numèriques. 

```{r}
anyNA(assay(se)) #No hi ha valors faltants (NA) en la matriu de dades 
```



```{r}
colnames(colData(se))
```
```{r}
colData(se)
```
Podem observar de forma general que aquestes dades consten d'un OOP *summarizedExperiment* on la matriu de dades està format per 77 pacients (columnes) els quals estàn dividits pel grup "Muscle.Loss" i 63 metabòlits (files) que són les concentracions de diferents metabòlits analitzades en les mostres d'orina proporcionades pels pacients. 




```{r}
Creatina <- assay(se)["Creatine", ] #Extraim le concentracions del metabòlit "creatine"
muscle_loss <- colData(se)$Muscle.loss #ExtraIm el grup Muscle.loss
#Creem un histograma 
hist(Creatina,
     main = "Creatina segons",
     xlab = "Concentració",
     col = "lightblue")
```
```{r}
boxplot(Creatina ~ muscle_loss,
        main = "Creatina segons Muscle.loss",
        xlab = "Grup",
        ylab = "Concentració de creatina",
        ylim = c(0, 1000))
```
```{r}
t.test(Creatina ~ muscle_loss)
```
Mitjançant aquest anàlisi bàsic podem observar que el metabòlit creatina mostra una diferència significativa en la concentració entre els grups Muscle.loss. Observem que la mitjana en el grup que tenen *cachexia* (pèrdua constant de massa muscular) és significativament superior (174.91) a la del grup control (51.50) amb un interval de confiança de [20.32 - 226.50]. Aquests resultats poden indicar que la concentració de creatina en la orina podria estar relacionada amb l'estat de cachexia i, per tant, podria ser un potencial marcador per ajudar a diagnosticar aquesta malaltia. 


```{r}
rownames(se)
```

Seguidament, sseguirem amb l'anàlisis estadístic descriptiu mitjançant un boxplot múltiple. Com que no podem fer un boxplot dels 63 metabòlits, farem un t-test univariant per a cada metabòlit i seleccionarem els 6 metabòlits que tinguin p-valors més baixos. 

```{r}
metab <- assay(se)
group <- colData(se)$Muscle.loss
#Fem un t-test per a cada metabòlit i guardem els p-valors dels t-tests
p_valors <- apply(metab, 1, function(x) {
  tryCatch(t.test(x ~ group)$p.value, error = function(e) NA)
})
#Ordenem els metabòlits segons els p-valors que tinguin del t-test
p_valors_ordenats <- sort(p_valors)
top_metabolits <- names(p_valors_ordenats)[1:4]
top_metabolits
```
Aquests són els metabòlits que han donat més nivell de significació fent el t-test segons la variable grup *Muscle.loss*. Per tant, haurien de ser els que tenen diferències més significatives de concentracions segons si els pacients tenen *cachexia* o no. 

```{r}
library(reshape2)
library(ggplot2)
#Seleccionem els metabòlits
top_metabolits <- c("Valine", "N.N-Dimethylglycine", "Leucine", "Quinolinate")
#Extraïm la matriu només amb els metabòlits seleccionats
top_data <- assay(se)[top_metabolits, ]
#Preparem les dades per ggplot2 (passem les mostres a les files en comptes de les columnes i anyadim la columna group "Muscle.loss")
top_data_prep <- as.data.frame(t(top_data))
top_data_prep$group <- colData(se)$Muscle.loss #Anyadim la columna group
#Format compatible amb boxplot
data_met <- reshape2::melt(top_data_prep, id.vars = "group",
                           variable.name = "metabòlit",
                           value.name = "concentració")
#Amb les dades preparades, procedim a fer el boxplot múltiple
ggplot(data_met, aes(x = metabòlit, y = concentració, fill = group)) + 
  geom_boxplot(outlier.size = 1) +
  labs(title = "Boxplot múltiple dels metabòlits més rellevants",
       x = "Metabòlit",
       y = "Concentració") + 
  scale_fill_manual(values = c("cachexic" = "red", "control" = "green")) + #Separem grups amb colors (Muscle.loss)
  theme_minimal()
```
Aquest gràfic mostra les diferències de concentracions dels 4 metabòlits que presenten més diferències significatives segons la variables categórica *Muscle.loss*. Tal i com s'observa en el gràfic, els 4 metabòlits tenen majors concentracions en els individus que presenten la malaltia *cachexia* que en els individus del grup control. 



**Pas 1: Anàlisi de Components Principals (PCA)**

Mitjançant aquest tipus d'anàlisis, l'objectiu serà reduïr la dimensió de les dades i visualitzar si les mostres s'agrupen segons "Muscle.Loss" (*cachexia/control*) basant-se en els seus perfils metabolòmics:


***Matriuc covariança FACER****





```{r}
#Trasposem la matriu per tenir les mostres com a files i els metabòlits com a columnes
t_data <- t(assay(se))
cach_control <- colData(se)$Muscle.loss
#És recomanable centrar i escalar les variables quan estàn en diferents escales, en el nostre cas alguns metabòlits tenen concentracions molt diferents, així que escalarem:
pca_resultats <- prcomp(t_data, scale. = TRUE) #Calcula internament la matriu de covariàncies i centra les dades (Scale)  
summary(pca_resultats)
```
Observem en els resultats de l'anàlisis de components principals que els dos primers ja tenen una variabilitat del **48.61%**, que ja es considera bastant alta per ser dades òmiques. Seguidament 

```{r}
var_explicada <- summary(pca_resultats)$importance[2, ] * 100 #Seleccionem PC1 i PC2 
barplot(var_explicada,
        main = "Variànça explicada per component",
        xlab = "Components principals",
        ylab = "% Variànça explicada", 
)

```

Ara ut8ilitzarem els valors dels primers components principals per a obtenir una representació de les dades en una dimensió reduïda. 

```{r}
pca_d <- as.data.frame(pca_resultats$x) #Cada fila representa una mostra i cada columna un PCA
pca_d$group <- cach_control #Afegim la classe de cada mostra
library(ggplot2)
ggplot(pca_d, aes(x = PC1, y = PC2, color = group)) + #Separem per grup segons el color
  geom_point(size = 3) +
  labs(
    title = "Anàlisis de components principals (PCA)",
    x = paste0("PC1(", round(var_explicada[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explicada[2], 1), "%)")
    
  ) + theme_minimal()
```
S'ha realitzar un anàlisi de components principals sobre la matriu de concentracions de metabòlits. Prèviament s'han centrat i escalat les dades per a evitar que les diferències d'escala entre les variables afectin l'anàlisi. Els dos primers components principals, com es pot observar, expliquen gairebé un 50% de la variànça total (48.6%). 


La magnitud de la contribució de cada variable a  les PC són els seus "loadings" en cada PC. Els autovectors (eigenvectors) associats a la matriu de covariànça són els loadings, indiquen quina direcció prenen els nous components i quines variables (metabòlits) contribueixen més. 
```{r}
#Creem un data frame ambv els loadings
loadings_pca <- as.data.frame(pca_resultats$rotation) 
loadings_pca$metabolit <- rownames(loadings_pca)
```

```{r}
top_PC1 <- loadings_pca[order(abs(loadings_pca$PC1), decreasing = TRUE), ][1:10, ]

ggplot(top_PC1, aes(x =reorder(metabolit, PC1), y = PC1)) + 
  geom_col(fill = "steelblue") + 
  coord_flip() + 
  labs(title = "Principals metabolits que contribueixen a PC1", 
       x = "Metabòlit",
       y = "Pes (loading) en PC1") + 
  theme_minimal()
```

**CLUSTERING JERÀRQUIC**

El clustering jeràquic és un potent recurs per a l'anàlisis exploratori de dades, porporcionant mètodes potents i flexibles per descubrir grups en les dades. 

```{r}
dades_s <- scale(t_data) #Matriu amb mostres com a files i metabòlits com a columnes (t) i escalada
dist_mostres <- dist(dades_s, method = "euclidean") #Calculqem la matriu de distàncies (eucledian)
hc <- hclust(dist_mostres, method = "complete") #Mètode de distància escollit: "Complete link", màxim de desimilituds per parells
grups <- colData(se)$Muscle.loss #grups per etiquetal segons Muscle.loss
#Gràfic del dendograma 
library(dendextend)
dend <- as.dendrogram(hc)
labels_colors(dend) <- ifelse(grups == "cachexic", "limegreen", "orange") #Dividim les mostres segons el grup visualment separat per colors 
plot(dend, 
     main = "Clustering jeràrquic amb grups",
     cex = 0.6)
```

Observem en el dendrograma que hi ha una separació visible entre els dos grups principals (*cachexia* i *control*), tot i que no està perfectament separada perquè algunes mostres *cachexia* (vermell) queden barrejades amb *control* (blau). Això pot indicar que pot haver efectes tècnics que desconeixem i/o que només alguns metabòlits separen clarament els dos grups (no tots). 


**Heatmap**

Un heatmapa amb 63 variables (meatbòlits) seria massa sorollós i difícil d'interpretar. Per tant, abans de fer el heatmap farem una selecció prèvia dels metabòlits (variables) més significatius.

```{r}
#Com ho hem fet anteriorment, ja tenim els p-valors ordenats dels metabòlits
p_valors_ordenats <- sort(p_valors)
top_metabolits_heatmap <- names(p_valors_ordenats)[1:10] #Seleccionem els 10 metabòlits més significatius
top_metabolits_heatmap
```
```{r}
#extraim les dades només per als meta`+bolits més significatius
mat <- metab[top_metabolits_heatmap, ] #10 files (metabòlits) x 77 mostres (pacients)
#Escalem pels metabòlits (mitjana 0, desviació 1)
mat_scaled <- t(scale(t(mat))) #trasposem, escalem i tornem a transposar després
```

El heatmap mostratà les mostres (pacients) i els metabòlits, però no sap quin grup pertany cada mostra. Per tant, hem de fer que el mapa pugui caracteritzar les mostres segons el grup que pertany, li hem de donar la informació.
```{r}
anotacions <- data.frame(Grup = grups) #Creem un petit dataframe amb la columna grup (cachexia/control) i una fila per cada mostra 
rownames(anotacions) <- colnames(mat_scaled) #Així el heatmap sabrà que x columna és la mostra PIF_xxx i que pertany al grup "cachexic", per exemple
head(anotacions)
```

```{r}
library(pheatmap)
pheatmap(mat_scaled, #Matriu de dades de 10 meatbòlits per 77 mostres (pacients) 
         annotation_col = anotacions, #Afegeix una linea de colors a dalt del mapa indicant si la mostra és cachexic o control
         annotation_colors = list(
           Grup = c(cachexic = "limegreen", control  ="orange") #Definim el color per cada grup
         ),
         scale = "none", #None, ja hem escalat els valors manualment
         clustering_distance_rows = "euclidean", #Mètode per agrupar metabòlits
         clustering_distance_cols = "euclidean", #Mètode per agrupar mostres 
         clustering_method = "complete", #clustering jeràrquic
         main = "Heatmap dels 10 metabòlits més significatius",
         fontsize_row = 7, #Tamany text dels metabòlits significatius 
         fontsize_col = 4) #Tamany text de les mostres
```










```{r}

```












**Referències**

https://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/117-hcpc-hierarchical-clustering-on-principal-components-essentials/

https://www.datanovia.com/en/blog/cluster-analysis-in-r-practical-guide/












